Bottomwell Skill Progression Plan
=================================

Plan-ID: BOTTOMWELL_SKILL_PROGRESSION_PLAN
Depends-On: BOTTOMWELL_PLAN, DIGGING_CAMERA_DESCENT_PLAN

Status
- Current: NOT_STARTED
- Last Reviewed: 2026-02-14
- Notes: v1 scope intentionally excludes biome-specific mechanics and multipliers.

Goal
- Evolve board height to `20 + bottomwell_rows + deep_shaft_rows`.
- Add a focused bottomwell skill branch set:
  - Deep Shaft (depth vision)
  - Extraction (Ore Magnet, Coin Seams, Refinery)
  - Excavation Control (Backfill Lattice, Guide Rails)
- Keep behavior deterministic for same seed + skill loadout + input timeline.

Non-Goals (v1)
- No biome-conditional multipliers or biome-unique mechanics yet.
- No milestone wall interactions yet (covered by `MILESTONE_DEPTH_WALL_PLAN`).
- No new piece types or active abilities.

Dependencies
- `game/src/tetris_core.rs` for board sizing, bottomwell generation, reward counting.
- `game/src/skilltree.rs` for effect schema and run-mod aggregation.
- `game/src/playtest.rs` for logic wiring from run-mods to core behavior.
- `game/src/bin/headful/main.rs` for run tuning + meta-money conversion.
- `game/assets/skilltree.json` for concrete node definitions and prereq graph.
- Coordinate viewport feel with `plans/digging_camera_descent_plan.txt`.

Design Rules
- Deterministic first: all row-shaping effects must remain seed/depth reproducible.
- Keep board width fixed at 10; only vertical size changes in v1.
- Avoid hidden/random one-off buffs; every effect should be visible and explainable.
- Prioritize small, composable modifiers over one large opaque formula.

Core Contracts
- Base visible board height is `20 + bottomwell_rows`.
- `deep_shaft_rows` is additive from unlocked skills (ranked, capped).
- Effective board height:
  - `effective_board_height = 20 + bottomwell_rows + deep_shaft_rows`
- Ore/Coin weighting modifiers apply during earth row generation only.
- Excavation control modifies hole placement deterministically before finalizing a row.

Execution Checklist
- [ ] Phase 1: extend skill effect model + run mods for bottomwell progression.
- [ ] Phase 2: add dynamic board height from deep shaft rows.
- [ ] Phase 3: wire Ore Magnet / Coin Seams into earth-row weighting.
- [ ] Phase 4: wire Refinery into score + meta-money conversion.
- [ ] Phase 5: add deterministic hole patch/alignment controls.
- [ ] Phase 6: add/update skilltree asset nodes and prerequisite graph.
- [ ] Phase 7: add deterministic/unit/integration coverage and tune values.
- [ ] Acceptance: deep shaft/extraction/excavation skills alter run behavior as designed.

Phase 1: Skill Effects and Run Mods
- Extend `SkillEffect` with bottomwell-focused variants (or equivalent composable shape):
  - `AddDeepShaftRows { rows }`
  - `AddOreWeight { points }`
  - `AddCoinWeight { points }`
  - `AddOreScoreValue { points }`
  - `AddCoinScoreValue { points }`
  - `AddOreMoneyValue { points }`
  - `AddCoinMoneyValue { points }`
  - `AddHolePatchChanceBp { basis_points }`
  - `AddHoleAlignChanceBp { basis_points }`
- Extend `SkillTreeRunMods` with matching fields.
- Keep saturating arithmetic and explicit caps for all aggregations.

Phase 2: Deep Shaft and Dynamic Board Height
- Replace fixed-height assumptions in `TetrisCore` with runtime board height field.
- Default no-skill value:
  - `20 + bottomwell_rows` (with current bottomwell defaults this is 23).
- Deep Shaft adds rows on top:
  - cap v1 at +3 rows (`deep_shaft_rows <= 3`) to limit layout/perf risk.
- Maintain existing board semantics:
  - bottom index remains y=0
  - reveal inserts at bottom and removes from top
  - spawn/collision bounds use effective board height

Phase 3: Extraction Branch Weighting
- Keep current base depth-scaled thresholds as baseline.
- Apply additive weights from skills after base depth logic, before final material pick.
- v1 rank values:
  - Ore Magnet: +2 ore weight per rank (3 ranks => +6)
  - Coin Seams: +1 coin weight per rank (3 ranks => +3)
- Clamp post-modifier thresholds to safe ranges to preserve garbage/stone presence.

Phase 4: Refinery Rewards
- Continue collecting `ore_collected` / `coins_collected` from cleared rows.
- Add Refinery contributions to both:
  - per-clear score payouts from ore/coin cells
  - run-end meta-money conversion
- v1 payout targets:
  - Base: ore=50 score, coin=200 score, ore=0 money, coin=0 money
  - Refinery rank 1: ore=75 score, coin=260 score, ore=1 money, coin=3 money
  - Refinery rank 2: ore=100 score, coin=320 score, ore=2 money, coin=6 money
- Keep default run money formula intact, then add refinery-derived money additively.

Phase 5: Excavation Control (Hole Repair + Alignment)
- Backfill Lattice (patching):
  - If generated row has 2 holes, optionally patch one hole.
  - Rank chances: 35% / 70% / 100%.
- Guide Rails (alignment):
  - Prefer at least one hole column aligned with prior depth row hole column.
  - Rank chances: 40% / 75% / 100%.
- Determinism constraints:
  - Use seeded/depth-derived roll sources only.
  - Define operation order explicitly:
    1) base holes
    2) patch pass
    3) alignment pass
    4) material fill pass

Phase 6: Skill Node Set (v1)
- Branch A: Deep Shaft
  - `deepShaft1` cost 30, requires `start`, effect `+1 deep_shaft_rows`
  - `deepShaft2` cost 60, requires `deepShaft1`, effect `+1 deep_shaft_rows`
  - `deepShaft3` cost 100, requires `deepShaft2`, effect `+1 deep_shaft_rows`
- Branch B: Extraction
  - `oreMagnet1` cost 25, requires `start`, effect `+2 ore weight`
  - `oreMagnet2` cost 55, requires `oreMagnet1`, effect `+2 ore weight`
  - `oreMagnet3` cost 90, requires `oreMagnet2`, effect `+2 ore weight`
  - `coinSeams1` cost 25, requires `start`, effect `+1 coin weight`
  - `coinSeams2` cost 55, requires `coinSeams1`, effect `+1 coin weight`
  - `coinSeams3` cost 90, requires `coinSeams2`, effect `+1 coin weight`
  - `refinery1` cost 120, requires `oreMagnet2`, `coinSeams2`,
    effects `+25 ore score`, `+60 coin score`, `+1 ore money`, `+3 coin money`
  - `refinery2` cost 180, requires `refinery1`,
    effects `+25 ore score`, `+60 coin score`, `+1 ore money`, `+3 coin money`
- Branch C: Excavation Control
  - `backfill1` cost 35, requires `start`, effect `+3500 patch bp`
  - `backfill2` cost 70, requires `backfill1`, effect `+3500 patch bp`
  - `backfill3` cost 110, requires `backfill2`, effect `+3000 patch bp` (cap 10000)
  - `guideRails1` cost 45, requires `backfill2`, effect `+4000 align bp`
  - `guideRails2` cost 85, requires `guideRails1`, effect `+3500 align bp`
  - `guideRails3` cost 130, requires `guideRails2`, effect `+2500 align bp` (cap 10000)

Phase 7: Tests
- Unit tests in `game/src/tetris_core.rs`:
  - effective board height reflects deep shaft ranks
  - reveal path keeps board height constant under dynamic height
  - ore/coin weighting changes material distribution in expected direction
  - patch/alignment passes obey deterministic seed/depth behavior
- Unit tests in `game/src/skilltree.rs`:
  - new effects aggregate to run-mods correctly
  - caps are respected
- Integration tests:
  - same seed + same unlocked nodes => identical board/reward timeline
  - refinery affects score and money as expected

Acceptance Criteria
- Deep Shaft increases visible board rows up to +3 without breaking controls/render.
- Ore Magnet/Coin Seams measurably increase ore/coin occurrence in bottomwell rows.
- Refinery increases ore/coin score payouts and contributes explicit meta-money.
- Backfill/Guide Rails reduce "cheese" and improve vertical hole continuity.
- All new behavior remains deterministic for fixed seed + loadout + inputs.

Risks and Mitigations
- Risk: taller board harms readability or piece spawn comfort.
  - Mitigation: cap Deep Shaft in v1 and tune with camera descent plan.
- Risk: extraction weighting overpowers economy.
  - Mitigation: clamp thresholds, keep additive values conservative, tune with playtests.
- Risk: alignment/patch interactions create opaque behavior.
  - Mitigation: strict operation order and debug counters in development builds.

Open Decisions
- Confirm hard cap for v1 Deep Shaft (`+3` proposed).
- Confirm whether `guideRails` should require `backfill2` (proposed) or be parallel from `start`.
- Confirm whether refinement money should be spendable immediately during run or only post-run.
