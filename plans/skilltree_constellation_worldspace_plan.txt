Skilltree Constellation Worldspace Plan
=======================================

Plan-ID: SKILLTREE_CONSTELLATION_WORLDSPACE_PLAN
Depends-On: OVERWORLD_SURFACE_START_BACKGROUND_PLAN, PERFORMANCE_BUDGET_HUD_PROFILER_PLAN

Status
- Current: NOT_STARTED
- Last Reviewed: 2026-02-14
- Owner: @hanzen (claimed 2026-02-14)
- Notes: Skilltree currently renders as a separate full-screen scene with a hard cut from Game Over. Target behavior is a diegetic transition where Tetris UI/frame melts away and the skilltree appears as a sky constellation in the same world.

Goal
- Make Tetris gameplay and skilltree feel like one shared worldspace instead of separate menus.
- When a run ends and player opens skilltree, transition through a short deterministic "melt away" reveal rather than a hard scene swap.
- Preserve gameplay determinism, input safety, and frame pacing.

Dependencies
- `game/src/view.rs` for view-state machine changes (`GameOver -> transition -> SkillTree`).
- `game/src/bin/headful/main.rs` for transition timing, input gating, and render orchestration.
- `game/src/tetris_ui.rs` for splitting skilltree draw behavior into panel-style and constellation-style presentation.
- `game/src/background.rs` for overworld/sky visual source and palette continuity.
- `engine/src/graphics.rs` rendering primitives (`fill_rect`, `blend_rect`, text) used for effect composition.
- Coordinate with `plans/headful_modularization_plan.txt` so transition logic can be extracted cleanly if modularization lands first.

Non-Goals
- No changes to skill unlock rules, costs, or progression save format.
- No redesign of editor-specific skilltree tools in v1.
- No per-pixel fluid simulation or shader-only effect requirements in v1.
- No major camera system rewrite across all scenes in this milestone.

Design Rules / Constraints
- Shared-world rule: board and constellation are treated as different layers/anchors in one world, not isolated menu scenes.
- End-of-run rule: gameplay simulation is already stopped before transition starts; transition is visual + navigation only.
- Determinism rule: melt ordering and timing are deterministic for the same seed and input timeline.
- Performance rule: v1 effect uses block/rect compositing and alpha blending; avoid expensive per-frame allocations.
- Readability rule: active board/piece readability remains intact during gameplay; only post-game-over transition may aggressively stylize.
- Scope rule: keep diff tight; avoid unrelated refactors while introducing the transition.

Current Baseline (for reference)
- `GameView::GameOver` currently moves directly to `GameView::SkillTree` on `OpenSkillTree`.
- `draw_skilltree_impl(...)` currently clears the full frame, enforcing hard scene replacement.
- Headful render path switches by `GameView` match arm rather than composing a transition state.

Execution Checklist
- [ ] Phase 1: add explicit skilltree transition state and timing contract.
- [ ] Phase 2: implement deterministic melt mask helpers and compositing primitives.
- [ ] Phase 3: render shared-world transition (frozen game-over layer -> sky + constellation reveal).
- [ ] Phase 4: add constellation-mode skilltree visuals while preserving existing interactions.
- [ ] Phase 5: add tests for state flow, determinism, and render integration.
- [ ] Phase 6: run manual playtest + profiling checks and tune defaults.
- [ ] Acceptance: opening skilltree from game over performs an in-world melt reveal into sky constellation view.

Phase 1: View Flow and Transition Contract
- Extend view flow to include a transition state between `GameOver` and `SkillTree` (for example: `SkillTreeTransition`).
- Define transition runtime data:
  - duration (ms)
  - elapsed progress (`0.0..1.0`)
  - deterministic seed source for melt ordering
  - optional skip-enabled flag/window
- Trigger path:
  - keyboard `K` in game-over
  - game-over "SKILL TREE" button action
- Completion path:
  - when progress reaches end (or skip), enter `GameView::SkillTree`.

Phase 2: Melt Effect Building Blocks
- Add pure helper(s) to compute melt threshold/alpha per block:
  - input: seed, block coordinates, normalized time
  - output: visibility/alpha for that block
- Use grid/block-based masking (coarse cells) for predictable cost and deterministic visuals.
- Define melt target surfaces:
  - board frame/outline and board-space HUD chrome
  - hold/next/pause UI
  - game-over panel/buttons/text chrome
- Keep effect directional (for example top-down or edge-in) with low-noise variation for "melting" feel.

Phase 3: Shared-World Transition Render Pipeline
- During transition view:
  - draw stable overworld sky background first
  - draw frozen run/game-over composition as foreground source
  - apply melt mask over melt targets so UI/frame dissolves away
  - fade/introduce constellation skilltree layer underneath/through the dissolve
- Ensure run state is not stepping while this view is active.
- Keep draw order explicit and testable to avoid accidental hard clears.

Phase 4: Constellation Skilltree Presentation
- Refactor skilltree draw path to support visual modes:
  - panel/menu mode (existing behavior)
  - constellation mode (diegetic sky presentation)
- Constellation mode adjustments:
  - nodes read as stars (small bright points/tiles)
  - dependency links read as constellation lines
  - heavy menu panel chrome reduced or deferred
- Preserve hit-testing and purchase/editor logic semantics; visual treatment changes only in v1.

Phase 5: Tests
- State machine tests in `game/src/view.rs`:
  - game-over open-skilltree enters transition state
  - transition completes/skips to skilltree
- Headful behavior tests in `game/src/bin/headful/headful_tests.rs`:
  - keyboard flow for transition entry and completion
  - gameplay actions remain blocked during transition
- Pure helper tests:
  - melt helper is deterministic for same seed/time
  - progression is monotonic (later time does not re-show hidden blocks)
- Render integration tests (where practical):
  - no full-frame hard clear in transition path
  - transition frames differ over time in expected direction

Phase 6: Manual Verification and Performance
- Manual checks:
  - End run -> open skilltree triggers melt reveal (no hard cut)
  - Tetris UI/frame elements visibly dissolve away
  - Skilltree appears as sky constellation and remains interactable once transition completes
  - Restart and quit flows from game-over remain correct
- Performance checks:
  - compare frame timing before/after transition feature
  - validate no sustained budget warnings during transition under representative play
- Suggested control-surface commands:
  - `./go.sh --start --game --headful`
  - `./go.sh --profile`

Acceptance Criteria
- Opening skilltree from game-over uses a deterministic melt transition rather than an immediate scene cut.
- Tetris frame/UI chrome visibly dissolves, revealing a sky-anchored constellation skilltree.
- Gameplay remains paused/stopped throughout the transition.
- Skilltree interactions work normally after transition completion.
- Frame pacing remains within established budget targets during normal and transition-heavy runs.

Risks and Mitigations
- Risk: transition effect reads as fade instead of "melt."
  - Mitigation: include directional threshold + local noise and tune block size/timing in manual passes.
- Risk: added compositing cost causes frame spikes.
  - Mitigation: coarse block mask, deterministic cached parameters, and budget profiling pass before default enable.
- Risk: state complexity increases regressions in menu/view flow.
  - Mitigation: explicit transition-state tests and isolated helper logic for timing/progression.
- Risk: constellation mode reduces node readability.
  - Mitigation: preserve contrast-first palette and defer nonessential visual flourishes to future extension.

Open Decisions
- Transition duration target (for example 600ms vs 900ms).
- Skip policy (always skippable, or only after minimum elapsed time).
- Whether main-menu "Skilltree Editor" should keep direct entry or optionally use a lighter worldspace transition.
- Whether v1 constellation mode should include twinkle/parallax animation or remain static for budget safety.

Future Extensions
- Camera travel from board area to sky anchor instead of pure dissolve.
- Audio-reactive dissolve timing and constellation highlight cues.
- Unified worldspace data model for other meta-systems (milestone walls, overworld landmarks).
