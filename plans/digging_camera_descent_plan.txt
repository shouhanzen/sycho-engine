Digging Camera Descent Feel Plan
================================

Plan-ID: DIGGING_CAMERA_DESCENT_PLAN
Depends-On: BOTTOMWELL_PLAN

Status
- Current: IN_PROGRESS (Phases 1-5 complete; Phase 6 manual pass pending)
- Last Reviewed: 2026-02-14
- Claimed By: cursor-agent @ 2026-02-14
- Notes: Added canonical depth helper + headful dig-camera controller + world-offset render path and tests. Added automated HUD/pause-hit-target stability coverage and non-interactive headful profile traces; final manual feel/perf verification still requires interactive headful run.

Goal
- Add a short downward camera motion when digging progresses so depth gain feels physical.
- Keep HUD and input hit-targets stable while only the world layer animates.
- Preserve deterministic behavior for the same seed and input timeline.

Dependencies
- `game/src/tetris_core.rs` for canonical depth progression (`earth_depth` in reveal flow).
- `game/src/bin/headful/main.rs` for per-frame update and run reset hooks.
- `game/src/tetris_ui.rs` for world/HUD split and board layout integration.
- `engine/src/render.rs` for board drawing primitives that currently assume centered layout.
- Coordinate with `plans/performance_budget_hud_profiler_plan.txt` for frame-budget checks.

Non-Goals
- No cinematic free camera or manual camera controls in v1.
- No changes to piece physics, gravity, line-clear rules, or scoring.
- No movement of HUD panels/pause button with camera animation.

Design Rules
- Use a single canonical dig signal (`earth_depth`) to drive camera and background depth.
- Camera effect should be event-driven (impulse on newly revealed depth), then smoothly settle.
- Clamp offset to a safe range so the board remains readable and fully in frame.
- Keep the default feature toggle-able for quick regressions/perf comparisons.
- Implement shared rendering primitives in `engine` first, then adopt from `game`.

Execution Checklist
- [x] Phase 1: lock depth contract and expose camera-friendly depth helper. (owner: cursor-agent @ 2026-02-14)
- [x] Phase 2: add gameplay dig-camera controller state and update rules in headful runtime.
- [x] Phase 3: add explicit board/world offset rendering path and preserve existing wrappers.
- [x] Phase 4: wire camera offset into tetris world render flow (background + board + piece layers).
- [x] Phase 5: add tests for controller math, render offset behavior, and reset semantics.
- [ ] Phase 6: run manual feel/performance tuning pass and set default constants.
- [ ] Acceptance: digging visibly pulls the world downward, then settles smoothly without HUD/input regressions.

Phase 1: Depth Contract and Source-of-Truth
- Add a helper on `TetrisCore` for render-facing depth input (for example `background_depth_rows()`).
- Ensure helper maps to canonical depth progression and avoids ad-hoc `lines_cleared()` usage.
- Update call sites that should be depth-driven to use this helper consistently.
- Done @ 2026-02-14: Added `TetrisCore::background_depth_rows()` and migrated world background depth callsite to use it.
- Verification: `cargo test -p game --test tetris_core_tests && cargo test -p game --test tetris_ui_tests`.

Phase 2: Headful Dig-Camera Controller
- Add a small camera state owned by `HeadfulApp`:
  - `last_depth_rows`
  - `offset_y_px`
  - optional tuning constants/cache
- Update each frame:
  - detect positive depth delta
  - add downward impulse (`offset_y_px += delta * step_px`)
  - clamp to `max_offset_px`
  - decay back toward zero at a fixed rate (`return_px_per_s`)
- Freeze/hold behavior while paused; continue settle on resume.
- Done @ 2026-02-14: Added `game/src/headful/dig_camera.rs` and integrated controller state/update/reset in `game/src/bin/headful/main.rs`.
- Verification: `cargo test -p game --bin headful`.

Phase 3: Engine-First Render Primitive
- Extend render support to draw board cells at an explicit board rect/offset rather than only centered.
- Keep current centered `draw_board_cells` API as a compatibility wrapper.
- Ensure outline, grid dots, and cell fill behavior are identical apart from origin.
- Done @ 2026-02-14: Added explicit-origin board draw API (`draw_board_cells_in_rect`) and kept centered `draw_board_cells` wrapper.
- Verification: `cargo test -p engine --test render_tests`.

Phase 4: World Render Integration
- Extend `draw_tetris_world` path to accept/apply vertical camera offset for world layers:
  - tile background board rect
  - locked board cells
  - ghost + active piece
- Keep `draw_tetris_hud*` anchored to unshifted UI layout.
- Keep input/view-tree hit rects stable (pause/hold buttons should not drift with camera).
- Done @ 2026-02-14: Added `draw_tetris_world_with_camera_offset`, shifted background/board/piece layers only, and kept HUD/layout/view-tree anchored to unshifted layout.
- Verification: `cargo test -p game --test tetris_ui_tests`.

Phase 5: Tests
- Add unit tests for camera controller:
  - depth delta creates impulse
  - no depth delta creates no impulse
  - settle rate approaches zero
  - max clamp prevents runaway offset
  - reset clears camera state
- Add render tests:
  - non-zero offset shifts world pixels compared to baseline
  - zero offset preserves existing deterministic output
- Add headful/runtime tests:
  - reset path zeroes dig-camera state
  - paused state does not continue integrating new motion unexpectedly
- Done @ 2026-02-14: Added controller unit tests, render offset tests, and headful runtime reset/pause tests.
- Verification: `cargo test -p engine --test render_tests && cargo test -p game --test tetris_core_tests && cargo test -p game --test tetris_ui_tests && cargo test -p game --bin headful`.

Phase 6: Manual Verification and Tuning
- Tune constants for feel:
  - `step_px_per_row`
  - `max_offset_px`
  - `return_px_per_s`
- Manual checks:
  - rapid multi-line clears feel punchy but readable
  - board remains in frame across common window sizes
  - HUD and click targets remain stable
- Profiling checks:
  - no sustained budget WARN/CRIT spikes versus baseline during representative play.
- Progress @ 2026-02-14: Default constants set in `game/src/headful/dig_camera.rs` (`step_px_per_row=11`, `max_offset_px=72`, `return_px_per_s=96`).
- Progress @ 2026-02-14: Added automated HUD/input anchor regression test `world_camera_offset_keeps_hud_layout_and_pause_hit_target_stable` in `game/tests/tetris_ui_tests.rs`; verified with `cargo test -p game --test tetris_ui_tests`.
- Progress @ 2026-02-14: Ran non-interactive headful profile traces via `go.sh` with dig camera disabled/enabled:
  - 600f (camera OFF): `update=0.088ms avg`, `draw=0.307ms avg`, `frame=12.217ms avg`.
  - 600f (camera ON): `update=0.113ms avg`, `draw=0.325ms avg`, `frame=15.828ms avg` (frame dominated by present jitter).
  - 1200f controlled rerun (camera OFF/ON): update+draw deltas remained within measurement noise (roughly `<=0.02ms` avg).
- Note @ 2026-02-14: `ROLLOUT_HEADFUL_PRESENT_MODE=immediate` is unsupported on this WSL surface (`Fifo` only), so present-mode tuning falls back and remains environment-limited in CLI profiling.
- Blocked @ 2026-02-14: Final feel/perf sign-off still requires an interactive headful session for visual readability checks (rapid clears), in-frame confirmation across window sizes, and manual HUD click-target validation while camera motion is visible.

Acceptance Criteria
- Dig progression triggers a clearly visible downward world motion within the same play sequence.
- Motion settles smoothly back to neutral without jitter or camera drift.
- HUD placement and UI interaction regions remain stable.
- Rendering remains deterministic for equal seed/depth/input timelines.
- No material frame pacing regression in representative headful runs.
- Status @ 2026-02-14: Automated tests now cover deterministic/controller/reset semantics plus HUD/pause-hit-target anchor stability under non-zero world offset; final acceptance remains blocked pending interactive headful feel/perf verification.

Risks and Mitigations
- Risk: camera motion causes readability issues during fast clears.
  - Mitigation: clamp max offset, keep settle fast, and tune by manual playtests.
- Risk: depth source divergence causes camera/background desync.
  - Mitigation: centralize depth helper and migrate call sites in Phase 1.
- Risk: render API changes break existing tests/paths.
  - Mitigation: preserve old wrapper behavior and add zero-offset parity tests.
- Risk: resets or view transitions leave stale camera state.
  - Mitigation: explicit reset hooks and dedicated runtime tests.

Open Decisions
- Should v1 use linear settle or critically damped smoothing for return-to-neutral?
- Should camera impulse scale linearly with rows cleared or use diminishing returns for 3-4 line clears?
- Should this be enabled by default immediately, or gated by an env toggle for one milestone?

Future Extensions
- Add small screen shake on milestone wall break events.
- Blend camera motion with biome transition bands for stronger depth storytelling.
- Expose camera tuning in debug UI/editor for faster iteration.
