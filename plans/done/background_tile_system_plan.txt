Tile-Based Background System Plan
=================================

Plan-ID: BACKGROUND_TILE_SYSTEM_PLAN

Status
- Current: DONE
- Last Reviewed: 2026-02-14
- Completed: 2026-02-14
- Notes: All phases implemented and verified. 16 background tests + 55 total game tests pass.

Goal
- Build a tile-based background that appears behind the Tetris board and scrolls as the player digs down.
- Use deterministic random tile patterns so each run feels varied but reproducible.
- Support depth-based biome transitions for future content expansion.

Core Vision
- Background is a separate visual layer (not gameplay collision).
- Tiles are generated from depth + seed, then rendered in a screen-space viewport.
- As dig depth increases, the background shifts downward and transitions biome themes.

Design Pillars
- Deterministic: same seed + same depth => same background tiles.
- Lightweight: render only visible background tiles.
- Layered: far/mid/near tile layers with different parallax factors.
- Extensible: add biomes, animated tiles, and effects without rewriting core logic.

Execution Checklist
- [x] Phase 1: establish `game/src/background.rs` architecture and runtime ownership model.
  - done: `game/src/background.rs` — `BackgroundBiome`, `BackgroundTileKind`, `BackgroundPalette`, `LayerConfig`.
  - Ownership: stateless render-only (Option A); determinism preserved via seed+depth inputs from `TetrisCore`.
- [x] Phase 2: add deterministic tile hash and weighted tile-kind sampling.
  - done: `tile_hash()` FNV-1a, `BackgroundTileKind::from_hash()` with per-biome weighted tables.
- [x] Phase 3: add depth-to-biome mapping with blend windows.
  - done: `biome_at_depth()`, `biome_with_transition()` with 10-row blend band around threshold.
- [x] Phase 4: integrate non-clearing board render path and background-first draw order.
  - done: `engine::render::draw_board_cells` (non-clearing); `tetris_ui::draw_tetris_world` composites background→board→piece.
- [x] Phase 5: implement viewport-based tile rendering with per-layer parallax.
  - done: `draw_tile_layer()` with `BASE_LAYER` (1x) and `PARALLAX_LAYER` (0.5x depth divisor, 2x tile size, alpha blend).
- [x] Phase 6: add procedural motif rendering for tile kinds.
  - done: `draw_tile_motif()` — dots, bars, veins, cracks, fossils; all procedural, no texture atlas.
- [x] Phase 7: apply performance safeguards and determinism constraints for hot paths.
  - done: only visible tiles rendered per layer; zero allocations in hot loop; fully deterministic for replay/profile.
- [x] Phase 8: add debug/tuning hooks for background controls.
  - done: env vars — `ROLLOUT_DISABLE_TILE_BG`, `ROLLOUT_FORCE_BIOME`, `ROLLOUT_PARALLAX_MULT`, `ROLLOUT_TILE_GRID_OVERLAY`.
- [x] Phase 9: add deterministic/hash/biome/integration tests.
  - done: 16 tests — hash determinism, hash variation, biome mapping, tile kind coverage/distribution, draw determinism, scroll verification.
- [x] Acceptance: background scrolls deterministically with smooth biome transitions and stable frame pacing.
  - verified: `cargo test -p game --lib` — 55/55 pass; background tests 16/16 pass.

Phase 1: Architecture and Ownership (DONE)
- Module: `game/src/background.rs`.
- No separate `BackgroundRuntime` struct needed — system is stateless, all state derived from `seed + depth_rows`.
- Definitions: `BackgroundBiome` (Dirt, Stone), `BackgroundTileKind` (8 variants), `BackgroundPalette`.
- Ownership: Option A (render-only). Determinism preserved because inputs (`seed`, `depth`) come from `TetrisCore`.

Phase 2: Seeded Tile Generation (DONE)
- `tile_hash(seed, depth_row, col, layer_id) -> u32` using FNV-1a mixing.
- `BackgroundTileKind::from_hash(hash, biome)` with weighted tables:
  - Dirt: 62% Empty, 20% DirtA, 12% DirtB, 4% Crack, 2% Fossil.
  - Stone: 39% Empty, 23% RockA, 20% RockB, 10% Vein, 6% Crack, 2% Fossil.

Phase 3: Depth and Biome Mapping (DONE)
- Biome bands: 0..44 Dirt, 55+ Stone (threshold at 50, 10-row blend window).
- `biome_at_depth(depth)` — hard boundary lookup.
- `biome_with_transition(depth, hash)` — probabilistic blend in the transition band.

Phase 4: Render Pipeline Integration (DONE)
- `engine::render::draw_board_cells` — board drawing without full-screen clear.
- `tetris_ui::draw_tetris_world` implements compositing order:
  1) `draw_tile_background` (background layers)
  2) `draw_board_cells` (board outline + cells)
  3) `draw_ghost_and_active_piece`
  4) HUD/UI drawn separately.

Phase 5: Tile Viewport and Scrolling (DONE)
- `draw_tile_background(frame, width, height, board_rect, depth_rows, seed)` — public API.
- Two layers rendered back-to-front:
  - PARALLAX_LAYER: tile_px=48, depth_divisor=2, alpha=108.
  - BASE_LAYER: tile_px=24, depth_divisor=1, alpha=255.

Phase 6: Tile Art via Procedural Motifs (DONE)
- `draw_tile_motif()` — procedural drawing per tile kind:
  - DirtA/RockA: centered dot.
  - DirtB/RockB: scattered accent dots.
  - Vein: vertical bar.
  - Crack: horizontal + diagonal lines.
  - Fossil: rect outline.

Phase 7: Performance and Safety (DONE)
- Only visible tiles rendered per layer (viewport-bounded loops).
- Zero heap allocations in hot path.
- Fully deterministic: same seed+depth → same pixel output (verified by tests).

Phase 8: Debug and Tuning Hooks (DONE)
- Env vars (all OnceLock-cached):
  - `ROLLOUT_DISABLE_TILE_BG=1` — disable background entirely.
  - `ROLLOUT_FORCE_BIOME=dirt|stone` — force all tiles to a single biome.
  - `ROLLOUT_PARALLAX_MULT=<float>` — scale parallax layer depth divisor (0.1–10.0).
  - `ROLLOUT_TILE_GRID_OVERLAY=1` — thin white grid overlay on tile boundaries.

Phase 9: Tests (DONE)
- 16 unit/integration tests in `game/src/background.rs::tests`:
  - `tile_hash_deterministic`, `tile_hash_varies_with_{seed,depth,col,layer}`.
  - `tile_kind_deterministic`, `tile_kind_covers_all_rolls_{dirt,stone}`, `tile_kind_distribution_*`.
  - `biome_dirt_below_threshold`, `biome_stone_at_and_above_threshold`.
  - `depth_to_background_row_offset_is_identity_in_mvp`, `...is_monotonic`.
  - `draw_tile_background_same_seed_and_depth_matches`, `...scrolls_when_depth_changes`.

Acceptance Criteria
- Background scrolls downward as player digs deeper.
- Tile patterns are deterministic per seed/depth.
- Biome transitions occur at configured depth bands with smooth blending.
- Board and gameplay readability remain clear.
- No noticeable frame-time spikes from background rendering.

Future Upgrades
- Animated special tiles (glow, shimmer, lava pulse).
- Rare landmarks every N depth rows.
- Biome-specific particle systems tied to depth.
- Upgrade system hooks: reveal scanner, richer ore vein visuals, hazard warnings.
